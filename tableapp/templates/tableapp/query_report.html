{% extends 'tableapp/base.html' %}
{% load custom_filters %}

{% block title %}Reporte PVO{% endblock %}

{% block content %}

<!-- Header con bot√≥n a la derecha -->
<div class="d-flex align-items-center justify-content-between mb-2">
  <h2 class="page-title m-0">üìä Reporte de Pedidos Activos</h2>
  <a class="btn btn-success btn-sm" id="btnExportar" href="{% url 'query_report_export' %}">
    ‚¨áÔ∏è Exportar Excel
  </a>
</div>

<input type="hidden" id="csrf-token" value="{{ csrf_token }}">

<div class="card shadow-sm rounded">
  <div class="table-responsive" style="max-height: 75vh;">
    <table class="table table-hover table-bordered align-middle text-center" id="tablaPVO">
      <thead class="sticky-top" style="background-color: #1e293b; color: #fff;">
        <tr>
          {% for col in columns %}
            {% if col == 'Fecha Pedido' %}
              <th class="text-nowrap">{{ col }}</th>
            {% elif col == 'Fecha Requerida' %}
              <th class="text-nowrap">{{ col }}</th>
              <th class="text-nowrap">FULL<br><small>(√∫ltimo insumo)</small></th>
              <th class="text-nowrap">Obs FULL</th>
              <th class="text-nowrap">FLP<br><small>(liberaci√≥n planta)</small></th>
              <th class="text-nowrap">Obs FLP</th>
              <th class="text-nowrap">FIF<br><small>(inicio fab.)</small></th>
              <th class="text-nowrap">FEF<br><small>(entrega final)</small></th>
              <th class="text-nowrap">Obs FEF</th>
            {% elif col in fp_cols %}
              <th class="text-nowrap fp-col">{{ col }}</th>
            {% elif col not in skip_cols and col != 'Fecha Entrega Planta' and col != 'Fecha Estimado Fin' and col != 'Fecha FULL' and col != 'Fecha FLP' and col != 'Fecha FIF' and col != 'Fecha FEF' %}
              <th class="text-nowrap">{{ col }}</th>
            {% endif %}
          {% endfor %}
          {% if perms.can_view_history %}
            <th class="text-nowrap">Acciones</th>
          {% endif %}
        </tr>

        <tr>
          {% for col in columns %}
            {% if col == 'Fecha Pedido' %}
              <th><input type="text" class="form-control form-control-sm" placeholder="Filtrar..." onkeyup="filtrarTabla({{ forloop.counter0 }})"></th>
            {% elif col == 'Fecha Requerida' %}
              <th><input type="text" class="form-control form-control-sm" placeholder="Filtrar..." onkeyup="filtrarTabla({{ forloop.counter0 }})"></th>
              <th><input type="text" class="form-control form-control-sm" placeholder="Filtrar..." onkeyup="filtrarTabla({{ forloop.counter0|add:1 }})"></th>
              <th><input type="text" class="form-control form-control-sm" placeholder="Filtrar..." onkeyup="filtrarTabla({{ forloop.counter0|add:2 }})"></th>
              <th><input type="text" class="form-control form-control-sm" placeholder="Filtrar..." onkeyup="filtrarTabla({{ forloop.counter0|add:3 }})"></th>
              <th><input type="text" class="form-control form-control-sm" placeholder="Filtrar..." onkeyup="filtrarTabla({{ forloop.counter0|add:4 }})"></th>
              <th><input type="text" class="form-control form-control-sm" placeholder="Filtrar..." onkeyup="filtrarTabla({{ forloop.counter0|add:5 }})"></th>
              <th><input type="text" class="form-control form-control-sm" placeholder="Filtrar..." onkeyup="filtrarTabla({{ forloop.counter0|add:6 }})"></th>
              <th><input type="text" class="form-control form-control-sm" placeholder="Filtrar..." onkeyup="filtrarTabla({{ forloop.counter0|add:7 }})"></th>
            {% elif col in fp_cols %}
              <th class="fp-col"><input type="text" class="form-control form-control-sm" placeholder="Filtrar..." onkeyup="filtrarTabla({{ forloop.counter0 }})"></th>
            {% elif col not in skip_cols and col != 'Fecha Entrega Planta' and col != 'Fecha Estimado Fin' and col != 'Fecha FULL' and col != 'Fecha FLP' and col != 'Fecha FIF' and col != 'Fecha FEF' %}
              <th><input type="text" class="form-control form-control-sm" placeholder="Filtrar..." onkeyup="filtrarTabla({{ forloop.counter0 }})"></th>
            {% endif %}
          {% endfor %}
          {% if perms.can_view_history %}
            <th></th>
          {% endif %}
        </tr>
      </thead>

      <tbody>
        {% for row in registros %}
          <tr data-pid="{{ row|get_item:'PID' }}">
            {% for col in columns %}
              {% if col == 'Fecha Pedido' %}
                <td class="text-nowrap" data-order="{{ row|get_item:col|date:'Y-m-d' }}">{{ row|get_item:col|date:"d/m/y" }}</td>

              {% elif col == 'Fecha Requerida' %}
                <td class="text-nowrap" data-order="{{ row|get_item:col|date:'Y-m-d' }}">{{ row|get_item:col|date:"d/m/y" }}</td>

                {% if perms.can_edit_full %}
                  <td hx-put="{% url 'actualizar_fecha' row|get_item:'PID' 'FULL' %}" hx-include="closest td" hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}' hx-trigger="change" hx-swap="none">
                    <input type="date" name="fecha" value="{{ row|get_item:'Fecha FULL'|date:'Y-m-d' }}" class="form-control form-control-sm w-100">
                  </td>
                  <td>
                    <button type="button" class="btn btn-sm btn-outline-secondary w-100"
                            data-bs-toggle="modal" data-bs-target="#obsModal"
                            data-pid="{{ row|get_item:'PID' }}"
                            data-campo="OBS_FULL"
                            data-obs="{{ row|get_item:'Obs FULL'|default_if_none:''|escape }}">
                      {% if row|get_item:'Obs FULL' %}‚úé Editar{% else %}‚ûï Agregar{% endif %}
                    </button>
                  </td>
                {% else %}
                  <td class="text-nowrap">{{ row|get_item:'Fecha FULL'|default:"‚Äî" }}</td>
                  <td class="text-nowrap">{{ row|get_item:'Obs FULL'|default:"‚Äî" }}</td>
                {% endif %}

                {% if perms.can_edit_flp %}
                  <td hx-put="{% url 'actualizar_fecha' row|get_item:'PID' 'FLP' %}" hx-include="closest td" hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}' hx-trigger="change" hx-swap="none">
                    <input type="date" name="fecha" value="{{ row|get_item:'Fecha FLP'|date:'Y-m-d' }}" class="form-control form-control-sm w-100">
                  </td>
                  <td>
                    <button type="button" class="btn btn-sm btn-outline-secondary w-100"
                            data-bs-toggle="modal" data-bs-target="#obsModal"
                            data-pid="{{ row|get_item:'PID' }}"
                            data-campo="OBS_FLP"
                            data-obs="{{ row|get_item:'Obs FLP'|default_if_none:''|escape }}">
                      {% if row|get_item:'Obs FLP' %}‚úé Editar{% else %}‚ûï Agregar{% endif %}
                    </button>
                  </td>
                {% else %}
                  <td class="text-nowrap">{{ row|get_item:'Fecha FLP'|default:"‚Äî" }}</td>
                  <td class="text-nowrap">{{ row|get_item:'Obs FLP'|default:"‚Äî" }}</td>
                {% endif %}

                {% if perms.can_edit_fif %}
                  <td hx-put="{% url 'actualizar_fecha' row|get_item:'PID' 'FIF' %}" hx-include="closest td" hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}' hx-trigger="change" hx-swap="none">
                    <input type="date" name="fecha" value="{{ row|get_item:'Fecha FIF'|date:'Y-m-d' }}" class="form-control form-control-sm w-100">
                  </td>
                {% else %}
                  <td class="text-nowrap">{{ row|get_item:'Fecha FIF'|default:"‚Äî" }}</td>
                {% endif %}

                {% if perms.can_edit_fef %}
                  <td hx-put="{% url 'actualizar_fecha' row|get_item:'PID' 'FEF' %}" hx-include="closest td" hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}' hx-trigger="change" hx-swap="none">
                    <input type="date" name="fecha" value="{{ row|get_item:'Fecha FEF'|date:'Y-m-d' }}" class="form-control form-control-sm w-100">
                  </td>
                  <td>
                    <button type="button" class="btn btn-sm btn-outline-secondary w-100"
                            data-bs-toggle="modal" data-bs-target="#obsModal"
                            data-pid="{{ row|get_item:'PID' }}"
                            data-campo="OBS_FEF"
                            data-obs="{{ row|get_item:'Obs FEF'|default_if_none:''|escape }}">
                      {% if row|get_item:'Obs FEF' %}‚úé Editar{% else %}‚ûï Agregar{% endif %}
                    </button>
                  </td>
                {% else %}
                  <td class="text-nowrap">{{ row|get_item:'Fecha FEF'|default:"‚Äî" }}</td>
                  <td class="text-nowrap">{{ row|get_item:'Obs FEF'|default:"‚Äî" }}</td>
                {% endif %}

              {% elif col == 'Fecha Despacho' %}
                <td class="text-nowrap" data-order="{{ row|get_item:col|date:'Y-m-d' }}">{{ row|get_item:col|date:"d/m/y" }}</td>

              {% elif col == 'ESTADO FP' %}
                <td class="fp-col">
                  {% if perms.can_edit_dates %}
                    <select name="valor" class="form-control form-control-sm w-100"
                            hx-put="{% url 'actualizar_fp' row|get_item:'Codigo Producto' 'estado_fp' %}"
                            hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                            hx-vals='{"pid":"{{ row|get_item:"PID" }}"}'
                            hx-trigger="change" hx-swap="none">
                      <option value="">‚Äî</option>
                      {% for opt in catalogo.estados_fp %}
                        <option value="{{ opt }}" {% if opt == row|get_item:'ESTADO FP' %}selected{% endif %}>{{ opt }}</option>
                      {% endfor %}
                    </select>
                  {% else %}
                    {{ row|get_item:'ESTADO FP'|default:"‚Äî" }}
                  {% endif %}
                </td>

              {% elif col == 'FAMILIA' %}
                <td class="fp-col">
                  {% if perms.can_edit_dates %}
                    <select name="valor" class="form-control form-control-sm w-100"
                            hx-put="{% url 'actualizar_fp' row|get_item:'Codigo Producto' 'familia' %}"
                            hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                            hx-vals='{"pid":"{{ row|get_item:"PID" }}"}'
                            hx-trigger="change" hx-swap="none">
                      <option value="">‚Äî</option>
                      {% for opt in catalogo.familias %}
                        <option value="{{ opt }}" {% if opt == row|get_item:'FAMILIA' %}selected{% endif %}>{{ opt }}</option>
                      {% endfor %}
                    </select>
                  {% else %}
                    {{ row|get_item:'FAMILIA'|default:"‚Äî" }}
                  {% endif %}
                </td>

              {% elif col == 'TIPO' %}
                <td class="fp-col">
                  {% if perms.can_edit_dates %}
                    <select name="valor" class="form-control form-control-sm w-100"
                            hx-put="{% url 'actualizar_fp' row|get_item:'Codigo Producto' 'tipo' %}"
                            hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                            hx-vals='{"pid":"{{ row|get_item:"PID" }}"}'
                            hx-trigger="change" hx-swap="none">
                      <option value="">‚Äî</option>
                      {% for opt in catalogo.tipos %}
                        <option value="{{ opt }}" {% if opt == row|get_item:'TIPO' %}selected{% endif %}>{{ opt }}</option>
                      {% endfor %}
                    </select>
                  {% else %}
                    {{ row|get_item:'TIPO'|default:"‚Äî" }}
                  {% endif %}
                </td>

              {% elif col == 'PLANTA' %}
                <td class="fp-col">
                  {% if perms.can_edit_dates %}
                    <select name="valor" class="form-control form-control-sm w-100"
                            hx-put="{% url 'actualizar_fp' row|get_item:'Codigo Producto' 'planta' %}"
                            hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                            hx-vals='{"pid":"{{ row|get_item:"PID" }}"}'
                            hx-trigger="change" hx-swap="none">
                      <option value="">‚Äî</option>
                      {% for opt in catalogo.plantas %}
                        <option value="{{ opt }}" {% if opt == row|get_item:'PLANTA' %}selected{% endif %}>{{ opt }}</option>
                      {% endfor %}
                    </select>
                  {% else %}
                    {{ row|get_item:'PLANTA'|default:"‚Äî" }}
                  {% endif %}
                </td>

              {% elif col == 'TIEMPO FP' %}
                <td class="fp-col">
                  {% if perms.can_edit_dates %}
                    <input type="number" step="1" name="valor" autocomplete="off"
                           value="{{ row|get_item:'TIEMPO FP'|floatformat:'0' }}"
                           class="form-control form-control-sm w-100"
                           hx-put="{% url 'actualizar_fp' row|get_item:'Codigo Producto' 'tiempo_fp_horas' %}"
                           hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                           hx-vals='{"pid":"{{ row|get_item:"PID" }}"}'
                           hx-trigger="change" hx-swap="none"
                           onchange="this.setAttribute('value', this.value)">
                  {% else %}
                    {{ row|get_item:'TIEMPO FP'|floatformat:'0'|default:"‚Äî" }}
                  {% endif %}
                </td>

              {% elif col == 'BATCH' %}
                <td class="fp-col">
                  {% if perms.can_edit_dates %}
                    <input type="number" step="1" name="valor" autocomplete="off"
                           value="{{ row|get_item:'BATCH' }}"
                           class="form-control form-control-sm w-100"
                           onkeydown="if(event.key==='Enter'){event.preventDefault();}"
                           onchange="this.setAttribute('value', this.value)"
                           hx-put="{% url 'actualizar_fp' row|get_item:'Codigo Producto' 'batch' %}"
                           hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                           hx-vals='{"pid":"{{ row|get_item:"PID" }}"}'
                           hx-trigger="change" hx-swap="none">
                  {% else %}
                    {{ row|get_item:'BATCH'|default:"‚Äî" }}
                  {% endif %}
                </td>

              {% elif col == 'TAMANO_LOTE' %}
                <td class="fp-col">
                  {% if perms.can_edit_dates %}
                    <input type="number" step="1" name="valor" autocomplete="off"
                           value="{{ row|get_item:'TAMANO_LOTE' }}"
                           class="form-control form-control-sm w-100"
                           onchange="this.setAttribute('value', this.value)"
                           hx-put="{% url 'actualizar_fp' row|get_item:'Codigo Producto' 'tamano_lote' %}"
                           hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                           hx-vals='{"pid":"{{ row|get_item:"PID" }}"}'
                           hx-trigger="change" hx-swap="none">
                  {% else %}
                    {{ row|get_item:'TAMANO_LOTE'|default:"‚Äî" }}
                  {% endif %}
                </td>

              {% elif col == 'PERSONAL_FASE' %}
                <td class="fp-col">
                  {% if perms.can_edit_dates %}
                    <input type="number" step="1" name="valor" autocomplete="off"
                           value="{{ row|get_item:'PERSONAL_FASE' }}"
                           class="form-control form-control-sm w-100"
                           onchange="this.setAttribute('value', this.value)"
                           hx-put="{% url 'actualizar_fp' row|get_item:'Codigo Producto' 'personal_fase' %}"
                           hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                           hx-vals='{"pid":"{{ row|get_item:"PID" }}"}'
                           hx-trigger="change" hx-swap="none">
                  {% else %}
                    {{ row|get_item:'PERSONAL_FASE'|default:"‚Äî" }}
                  {% endif %}
                </td>

              {% elif col not in skip_cols and col != 'Fecha Entrega Planta' and col != 'Fecha Estimado Fin' and col != 'Fecha FULL' and col != 'Fecha FLP' and col != 'Fecha FIF' and col != 'Fecha FEF' %}
                <td class="text-nowrap">
                  {% if 'valor' in col|slugify %}
                    $ {{ row|get_item:col|format_miles }}
                  {% else %}
                    {{ row|get_item:col }}
                  {% endif %}
                </td>
              {% endif %}
            {% endfor %}

            {% if perms.can_view_history %}
              <td>
                <button class="btn btn-sm btn-outline-primary"
                        hx-get="{% url 'pvo_historial_modal' row|get_item:'PID' %}"
                        hx-target="#modalHistorial .modal-content"
                        hx-trigger="click"
                        data-bs-toggle="modal"
                        data-bs-target="#modalHistorial">
                  üìú Ver hist√≥rico
                </button>
              </td>
            {% endif %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{# ===== Modal OBS ===== #}
<div class="modal fade" id="obsModal" tabindex="-1" aria-labelledby="obsModalLabel" aria-hidden="true">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title" id="obsModalLabel">Observaci√≥n</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
    </div>
    <form id="obsForm" hx-put="" hx-headers='{"X-CSRFToken":"{{ csrf_token }}"}' hx-swap="none">
      <div class="modal-body">
        <textarea name="obs" rows="6" class="form-control" placeholder="Escribe la observaci√≥n..."></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary">Guardar</button>
      </div>
    </form>
  </div></div>
</div>

{# ===== Modal Hist√≥rico ===== #}
<div class="modal fade" id="modalHistorial" tabindex="-1" aria-labelledby="modalHistorialLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"></div></div>
</div>

<script>
function filtrarTabla(colIndex) {
  const input = event.target;
  const filtro = input.value.toLowerCase();
  const filas = document.getElementById('tablaPVO').querySelector('tbody').rows;
  for (let i = 0; i < filas.length; i++) {
    const celda = filas[i].cells[colIndex];
    if (celda) {
      const texto = celda.textContent || celda.innerText;
      filas[i].style.display = texto.toLowerCase().includes(filtro) ? '' : 'none';
    }
  }
}

// --- L√≥gica del modal de observaciones ---
const obsModal = document.getElementById('obsModal');
let currentObsBtn = null;
const actualizarFechaPattern = "{% url 'actualizar_fecha' 'PID' 'CAMPO' %}";

obsModal.addEventListener('show.bs.modal', (ev) => {
  currentObsBtn = ev.relatedTarget;
  const pid   = currentObsBtn.getAttribute('data-pid');
  const campo = currentObsBtn.getAttribute('data-campo');
  const valor = currentObsBtn.getAttribute('data-obs') || '';

  const form = document.getElementById('obsForm');
  const url = actualizarFechaPattern.replace('PID', pid).replace('CAMPO', campo);
  form.setAttribute('hx-put', url);
  form.querySelector('textarea[name="obs"]').value = valor;

  const nice = campo.replace('OBS_', '').toUpperCase();
  document.getElementById('obsModalLabel').textContent = `Observaci√≥n ${nice}`;
});

document.getElementById('obsForm').addEventListener('htmx:afterRequest', function () {
  if (currentObsBtn) {
    const nuevo = this.querySelector('textarea[name="obs"]').value;
    currentObsBtn.setAttribute('data-obs', nuevo);
    currentObsBtn.textContent = nuevo ? '‚úé Editar' : '‚ûï Agregar';
  }
  const modal = bootstrap.Modal.getInstance(obsModal);
  modal.hide();
});
</script>

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script>
  $(function () {
    $('#tablaPVO').DataTable({ ordering: true, paging: false, info: false, searching: false });
  });

  // Exporta visible si hay filtros activos
  document.getElementById('btnExportar').addEventListener('click', function (e) {
    const filas = Array.from(document.querySelectorAll('#tablaPVO tbody tr'));
    const visibles = filas.filter(tr => tr.style.display !== 'none');
    if (visibles.length && visibles.length < filas.length) {
      e.preventDefault();
      const pids = visibles.map(tr => tr.dataset.pid).filter(Boolean);
      const url = this.getAttribute('href') + '?pids=' + encodeURIComponent(pids.join(','));
      window.location.href = url;
    }
  });
</script>

<style>
  th.fp-col, td.fp-col { min-width: 160px; }
  td.fp-col select, td.fp-col input { min-width: 150px; }
</style>

{% endblock %}
